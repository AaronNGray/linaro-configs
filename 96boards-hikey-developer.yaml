- job:
    name: 96boards-hikey-developer
    project-type: freestyle
    defaults: global
    logrotate:
        daysToKeep: 30
        numToKeep: 30
        artifactNumToKeep: 1
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
                - job-workspace
    disabled: false
    node: docker-utopic-amd64
    display-name: '96boards - HiKey (developer kernel)'
    scm:
        - git:
            url: https://github.com/96boards/linux.git
            refspec: +refs/heads/hikey:refs/remotes/origin/hikey
            name: origin
            branches:
                - refs/heads/hikey
            skip-tag: true
            shallow-clone: true
            wipe-workspace: false
    wrappers:
        - timestamps
        - copy-to-slave:
            includes:
                - wifi.r8.5.tar.gz
        - build-name:
            name: '#${BUILD_NUMBER}-${GIT_REVISION,length=8}'
    builders:
        - shell: |
            #!/bin/bash

            set -ex

            trap cleanup_exit INT TERM EXIT

            cleanup_exit()
            {
              cd ${WORKSPACE}
              rm -rf lci-build-tools
              rm -rf builddir*
              rm -rf out
            }

            export LANG=C
            export make_bootwrapper=false
            export make_install=true
            export kernel_flavour=hikey
            export kernel_config=defconfig
            export MAKE_DTBS=true
            export ARCH=arm64
            export tcbindir="${HOME}/srv/toolchain/arm64-tc-15.08/bin"
            export toolchain_url=http://releases.linaro.org/components/toolchain/binaries/5.1-2015.08/aarch64-linux-gnu/gcc-linaro-5.1-2015.08-x86_64_aarch64-linux-gnu.tar.xz

            # Disable wireless configuration API
            # TI wl18xx R8.5 is using a backported CFG80211 and MAC80211
            tar zxf wifi.r8.5.tar.gz
            patch -p1 < ${WORKSPACE}/wifi.r8.5/kernel.patch/0001-defconfig-hikey-discard-CFG80211-and-MAC80211.patch
            echo "CONFIG_LOCALVERSION=\"-linaro-hikey\"" >> arch/arm64/configs/defconfig
            touch .scmversion

            # FIXME - temporary workaround
            echo "CONFIG_DRM_HISI_FBDEV=y" >> arch/arm64/configs/defconfig

            rm -rf configs lci-build-tools
            git clone --depth 1 http://git.linaro.org/ci/lci-build-tools.git
            git clone --depth 1 http://git.linaro.org/ci/job/configs.git
            bash -x lci-build-tools/jenkins_kernel_build_inst
    publishers:
        - archive:
            artifacts: 'linux-image-*-linaro-hikey_*.deb, linux-headers-*-linaro-hikey_*.deb'
        - email:
            recipients: 'fathi.boudra@linaro.org'

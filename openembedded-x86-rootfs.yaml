- job:
    name: openembedded-x86-rootfs
    project-type: matrix
    defaults: global
    logrotate:
        daysToKeep: 30
        numToKeep: 30
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
            linaro:
                - job-build
                - job-cancel
    disabled: false
    node: build
    display-name: 'OpenEmbedded rootfs (x86)'
    axes:
        - axis:
            type: slave
            name: label
            values:
                - build
        - axis:
            type: user-defined
            name: gcc_version
            values:
                - 4.9
        - axis:
            type: user-defined
            name: rootfs
            values:
                - lng
                - minimal
    execution-strategy:
        sequential: true
        touchstone:
            expr: 'rootfs=="minimal"'
    wrappers:
        - timestamps
        - matrix-tie-parent:
            node: build
    builders:
        - shell: |
            #!/bin/bash

            set -x

            export PATH="$HOME/bin:$PATH"

            # we clean build and populate it from cache
            bash -x pre-build-do-cleanup.sh

            # do a build
            bash -x init-and-build.sh -a x86 -g ${gcc_version} linaro-image-${rootfs}

            cd ${WORKSPACE}

            bash -x post-build-create-image-manifest.sh
            bash -x post-build-sort-out-downloads.sh

            # Capture what we're building in the build output.
            repo manifest -r

            cat << EOF > out/BUILD-INFO.txt
            Format-Version: 0.5

            Files-Pattern: *
            License-Type: open
            EOF

            cat << EOF > downloads/BUILD-INFO.txt
            Format-Version: 0.5

            Files-Pattern: *
            License-Type: open
            EOF
        - ssh:
            site: 'snapshots.linaro.org'
            target: '${JOB_NAME}/${BUILD_NUMBER}/openembedded/images/${rootfs}-x86-gcc-${gcc_version}/${BUILD_NUMBER}'
            source: 'out/**'
            timeout: 120000
            remove-prefix: 'out'
            always-publish-from-master: true
        - ssh:
            site: 'snapshots.linaro.org file-move'
            target: ''
            source: ''
            command: 'reshuffle-files --job-type prebuilt --job-name ${JOB_NAME} --build-num ${BUILD_NUMBER}'
            timeout: 120000
            always-publish-from-master: true
        - ssh:
            site: 'snapshots.linaro.org'
            target: '/openembedded/sources'
            source: 'downloads/**'
            timeout: 120000
            remove-prefix: 'downloads'
            always-publish-from-master: true
        - ssh:
            site: 'snapshots.linaro.org file-move'
            target: ''
            source: ''
            command: 'reshuffle-files --job-type openembedded --job-name sources --build-num 1'
            timeout: 120000
            always-publish-from-master: true
    publishers:
        - email:
            recipients: 'anders.roxell@linaro.org fathi.boudra@linaro.org koen.kooi@linaro.org riku.voipio@linaro.org trevor.woerner@linaro.org'

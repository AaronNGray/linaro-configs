- job:
    name: linaro-edk2-prep-matrix
    project-type: matrix
    defaults: global
    logrotate:
        daysToKeep: 30
        numToKeep: 30
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
            linaro:
                - job-read
                - job-extended-read
                - job-build
                - job-cancel
    disabled: false
    node: build
    child-workspace: .
    display-name: 'Linaro EDK II - UEFI Continuous Integration (pre-release) - Matrix'
#    scm:
#        - git:
#            url: http://git.linaro.org/git/uefi/linaro-edk2.git
#            refspec: +refs/heads/release-prep:refs/remotes/origin/release-prep
#            name: origin
#            branches:
#                - refs/heads/release-prep
#            basedir: linaro-edk2
#            skip-tag: true
#            shallow-clone: true
#            clean: true
#            wipe-workspace: false
#    triggers:
#        - pollscm: 'H/5 * * * *'
    axes:
        - axis:
            type: user-defined
            name: MX_B
            values:
                - qemu64
                - qemu
#                - juno-armbds
#                - juno
#                - fvp-base-armbds
#                - mustang
#                - fvp-foundation-armbds
#                - rtsm_a15mpcore-armbds
#                - tc2-armbds
#                - beagle-armbds
        - axis:
            type: user-defined
            name: MX_TYPE
            values:
                - RELEASE
                - DEBUG
        - axis:
            type: user-defined
            name: MX_TC
            values:

                - 48
                - 49
        - axis:
            type: slave
            name: label
            values:
                - docker-utopic
    execution-strategy:
        sequential: true
# Touchstone is used to build "most interesting" board first, and to also
# key actions that should only be done once per build (such as creating
# source tarball.
        touchstone:
            expr: 'MX_B=="qemu64" && MX_TYPE=="RELEASE" && MX_TC=="48"'

    wrappers:
        - timestamps
#        - build-name:
#            name: '#${BUILD_NUMBER}-${GIT_REVISION,length=8}'
        - matrix-tie-parent:
            node: build
    builders:
        - linaro-publish-token
        - shell: |
            #!/bin/bash

            export JOB_NAME=linaro-edk2-prep-matrix

            set -ex
            sudo apt-get update
            sudo apt-get install -y python-pycurl zip

            trap cleanup_exit INT TERM EXIT

            cleanup_exit()
            {
              cd ${WORKSPACE}
              rm -rf uefi-ci uefi-tools
              rm -rf ${JOB_NAME}-build
              rm -rf out
            }

            # Use pre-installed linaro toolchain
            [ ${MX_TC} == "48" ] && export PATH="${HOME}/srv/toolchain/arm-tc-14.04/bin:${HOME}/srv/toolchain/arm64-tc-14.04/bin:$PATH"
            [ ${MX_TC} == "49" ] && export PATH="${HOME}/srv/toolchain/arm-tc-15.02/bin:${HOME}/srv/toolchain/arm64-tc-15.02/bin:$PATH"

            git clone git://git.linaro.org/uefi/uefi-tools.git
            git clone git://git.linaro.org/people/roy.franz/uefi-ci.git -b rfranz-jenkins-test uefi-ci
            bash -x uefi-ci/uefi.sh

            builddir=${WORKSPACE}/${JOB_NAME}-build
            outdir=${WORKSPACE}/out

            rm -rf ${outdir}
            mkdir -p ${outdir}/gcc-${MX_TC}

            # move any *orig.tar.bz2 files separately to non-gcc based dir
            for f in ${builddir}/*orig.tar.bz2; do
                ## Check if the glob gets expanded to existing files.
                ## If not, f here will be exactly the pattern above
                ## and the exists test will evaluate to false.
                [ -e "$f" ]  || break  # No files exist, $f is glob pattern

                mv ${builddir}/*orig.tar.bz2 ${outdir}/
                break
            done
            mv ${builddir}/* ${outdir}/gcc-${MX_TC}
            find ${outdir}/ -name '*QEMU_EFI.fd' -exec bash -c 'in=${1}; out=${in%fd}img; cat $in /dev/zero | dd iflag=fullblock bs=1M count=64 of=$out; gzip -9 $out' _ {} \;

            find ${outdir}
            # Publish to snapshots
            wget https://git.linaro.org/ci/publishing-api.git/blob_plain/HEAD:/linaro-cp.py -O linaro-cp.py
            python ./linaro-cp.py --verbose --no-build-info out components/kernel/${JOB_NAME}/${BUILD_NUMBER}


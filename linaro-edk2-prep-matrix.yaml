- job:
    name: linaro-edk2-prep-matrix
    project-type: matrix
    defaults: global
    logrotate:
        daysToKeep: 30
        numToKeep: 30
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
            linaro:
                - job-read
                - job-extended-read
                - job-build
                - job-cancel
    disabled: false
    node: build
    child-workspace: .
    display-name: 'Linaro EDK II - UEFI Continuous Integration (pre-release) - Matrix'
#    scm:
#        - git:
#            url: http://git.linaro.org/git/uefi/linaro-edk2.git
#            refspec: +refs/heads/release-prep:refs/remotes/origin/release-prep
#            name: origin
#            branches:
#                - refs/heads/release-prep
#            basedir: linaro-edk2
#            skip-tag: true
#            shallow-clone: true
#            clean: true
#            wipe-workspace: false
#    triggers:
#        - pollscm: 'H/5 * * * *'
    axes:
        - axis:
            type: user-defined
            name: MX_B
            values:
                - qemu64
                - qemu
#                - juno-armbds
#                - juno
#                - fvp-base-armbds
#                - mustang
#                - fvp-foundation-armbds
#                - rtsm_a15mpcore-armbds
#                - tc2-armbds
#                - beagle-armbds
        - axis:
            type: user-defined
            name: MX_TYPE
            values:
                - RELEASE
                - DEBUG
        - axis:
            type: user-defined
            name: MX_TC
            values:

                - 48
                - 49
        - axis:
            type: slave
            name: label
            values:
                - docker-utopic
    execution-strategy:
        sequential: true
    wrappers:
        - timestamps
#        - build-name:
#            name: '#${BUILD_NUMBER}-${GIT_REVISION,length=8}'
        - matrix-tie-parent:
            node: build
    builders:
        - linaro-publish-token
        - shell: |
            #!/bin/bash

            export JOB_NAME=linaro-edk2-prep-matrix
            echo "MX_B: ${MX_B}"
            echo "MX_TYPE: ${MX_TYPE}"
            echo "BUILD_NUMBER: ${BUILD_NUMBER}"
            echo "WORKSPACE: ${WORKSPACE}"

            set -ex

            WS_BASE=$(pwd)
            echo "WS_BASE is: ${WS_BASE}"
            ls -al


            trap cleanup_exit INT TERM EXIT

            cleanup_exit()
            {
              cd ${WORKSPACE}
              rm -rf uefi-ci uefi-tools
            #  rm -rf ${JOB_NAME}-build
            #  rm -rf out
            }

            # Use pre-installed linaro toolchain
            [ ${MX_TC} == "48" ] && export PATH="${HOME}/srv/toolchain/arm-tc-14.04/bin:${HOME}/srv/toolchain/arm64-tc-14.04/bin:$PATH"
            [ ${MX_TC} == "49" ] && export PATH="${HOME}/srv/toolchain/arm-tc-15.02/bin:${HOME}/srv/toolchain/arm64-tc-15.02/bin:$PATH"

            git clone git://git.linaro.org/uefi/uefi-tools.git
            git clone git://git.linaro.org/people/roy.franz/uefi-ci.git -b rfranz-jenkins-test uefi-ci
            bash -x uefi-ci/uefi.sh

            builddir=${WORKSPACE}/${JOB_NAME}-build
            outdir=${WORKSPACE}/out

            rm -rf ${outdir}
            mkdir -p ${outdir}
            mv ${builddir}/* ${outdir}/
            find ${outdir}/ -name '*QEMU_EFI.fd' -exec bash -c 'in=${1}; out=${in%fd}img; cat $in /dev/zero | dd iflag=fullblock bs=1M count=64 of=$out; gzip -9 $out' _ {} \;

            ${HOME}/bin/linaro-cp out components/kernel/${JOB_NAME}/${BUILD_NUMBER}

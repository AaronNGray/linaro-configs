- job:
    name: ubuntu-arm64-rootfs
    project-type: matrix
    defaults: global
    logrotate:
        daysToKeep: 30
        numToKeep: 30
    properties:
        - authorization:
            anonymous:
                - job-read
                - job-extended-read
    disabled: false
    node: build
    child-workspace: .
    display-name: 'Linaro Ubuntu arm64 rootfs'
    scm:
        - git:
            url: git://git.linaro.org/ci/ubuntu-build-service.git
            refspec: +refs/heads/master:refs/remotes/origin/master
            name: origin
            branches: 
                - origin/master
            skip-tag: true
            shallow-clone: true
            clean: true
            wipe-workspace: false
    axes:
        - axis:
            type: slave
            name: label
            values:
                - build
        - axis:
            type: user-defined
            name: rootfs
            values:
                - nano
    execution-strategy:
        sequential: true
    wrappers:
        - timestamps
        - matrix-tie-parent:
            node: build
        - timeout:
            timeout: 120
    builders:
        - shell: |
            #!/bin/bash

            trap cleanup_exit INT TERM EXIT

            cleanup_exit()
            {
              cd ${WORKSPACE}
              sudo umount builddir
            }

            dpkg -s qemu-user-static |grep '^Version'
            dpkg -s live-build |grep '^Version'

            rm -f linaro-utopic-${rootfs}-* *.txt

            test -d builddir || mkdir builddir
            sudo mount -t tmpfs -o size=6G tmpfs builddir
            cp -a utopic-arm64-${rootfs} builddir/
            cd builddir/utopic-arm64-${rootfs}
            ./configure
            make
            sudo mv linaro-utopic-* ${WORKSPACE}

            cat << EOF > ${WORKSPACE}/BUILD-INFO.txt
            Format-Version: 0.5

            Files-Pattern: *
            License-Type: open
            EOF
        - ssh:
            site: 'snapshots.linaro.org'
            target: '${JOB_NAME}/${BUILD_NUMBER}/ubuntu/images/${rootfs}-arm64/${BUILD_NUMBER}'
            source: 'linaro-utopic-${rootfs}-*, *.txt'
            timeout: 120000
            always-publish-from-master: true
        - ssh:
            site: 'snapshots.linaro.org file-move'
            target: ''
            source: ''
            command: 'reshuffle-files --job-type prebuilt --job-name ${JOB_NAME} --build-num ${BUILD_NUMBER}'
            timeout: 120000
            always-publish-from-master: true
    publishers:
        - archive:
            artifacts: 'linaro-utopic-*.tar.gz'
            latest-only: true
        - email:
            recipients: 'fathi.boudra@linaro.org riku.voipio@linaro.org'
